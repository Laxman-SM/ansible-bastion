# Create new Elastic IP
- name: Allocate a new elastic IP without associating it to anything
  ec2_eip:
    state: present
    region: "{{ ec2_region }}"
    in_vpc: true
    release_on_disassociation: true
  register: elastic_ip_info

# Create new NAT service
- name: Create new NAT Gateway service using an allocation-id
  ec2_vpc_nat_gateway:
    state: present
    subnet_id: "{{ vpc_public_subnets_full[0].id }}"
    allocation_id: "{{ elastic_ip_info.allocation_id }}"
    region: "{{ ec2_region }}"
    wait: yes
  register: nat_gateway_info

# Update VPC routeing tables
- name: update vpc routing tables
  ec2_vpc:
    region: "{{ ec2_region }}"
    cidr_block: "{{ vpc_cidr_block }}"
    resource_tags: "{{ vpc_resource_tags }}"
    internet_gateway: "{{ vpc_internet_gateway|string }}"
    subnets: "{{ vpc.subnets }}"
    route_tables:
      - subnets: "{{ vpc.subnets | get_subnets('tier', 'public', 'cidr') }}"
        routes:
          - dest: 0.0.0.0/0
            gw: igw
        resource_tags: "{{ vpc_route_tables_tags }}"
      - subnets: "{{ vpc.subnets | get_subnets('tier', 'private', 'cidr') }}"
        routes:
          - dest: 0.0.0.0/0
            gw: "{{ nat_gateway_info.nat_gateway_id }}"
        resource_tags: "{{ vpc_route_tables_tags }}"
  register: ec2_vpc_out
