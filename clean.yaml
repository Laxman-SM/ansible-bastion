---
- hosts: localhost
  connection: local
  gather_facts: False
  vars_files:
  - group_vars/vpc.yaml
  - group_vars/bastion.yaml
  - group_vars/docker_registry.yaml
  tasks:

  # find vpc id
  - name: find vpc id
    ec2_vpc:
      region: "{{ ec2_region }}"
      cidr_block: "{{ vpc_cidr_block }}"
      resource_tags: "{{ vpc_resource_tags }}"
      internet_gateway: "{{ vpc_internet_gateway|string }}"
      subnets: "{{ vpc_subnets }}"
      wait: true
    register: vpc

  # delete NAT gateway & Elastic IP

  - name: get vpc public subnets
    set_fact:
      vpc_public_subnets_full: "{{ vpc.subnets | get_subnets_full('tier', 'public') }}"

  - name: get NAT gateway id using subnet id
    shell: "aws ec2 describe-nat-gateways --filter Name=subnet-id,Values={{ vpc_public_subnets_full[0].id }}"
    register: nat_gateway
    changed_when: False
  - set_fact:
      nat_gateway_info: "{{ nat_gateway.stdout | from_json }}"
  - set_fact:
      nat_gateway_id: "{{ nat_gateway_info.NatGateways[0].NatGatewayId }}"
    when:
      - nat_gateway_info.NatGateways[0] is defined
  - set_fact:
      nat_gateway_id: ""
    when: nat_gateway_id is undefined
  - set_fact:
      nat_network_interface_id: "{{ nat_gateway_info.NatGateways[0].NatGatewayAddresses[0].NetworkInterfaceId }}"
    when:
      - nat_gateway_info.NatGateways[0] is defined
      - nat_gateway_info.NatGateways[0].NatGatewayAddresses[0] is defined
  - set_fact:
      nat_network_interface_id: ""
    when: nat_network_interface_id is undefined

  - name: delete NAT gateways
    ec2_vpc_nat_gateway:
      state: absent
      nat_gateway_id: "{{nat_gateway_id }}"
      release_eip: true
      wait: yes
    ignore_errors: yes

  - name: disassociate Elastic IP
    ec2_eip:
      state: absent
      region: "{{ ec2_region }}"
      device_id: "{{ nat_network_interface_id }}"
      release_on_disassociation: true
    ignore_errors: yes

  # delete bastion machines
  - name: remove autoscale groups for bastion
    ec2_asg:
      region: "{{ ec2_region }}"
      name: "{{ item.name }}"
      launch_config_name: "{{ item.lc_name }}"
      state: absent
    with_items:
      - { name: "{{ bastion_asg_name }}", lc_name: "{{ bastion_lc_name }}" }
    ignore_errors: yes

  - name: remove launch configurations for bastion
    ec2_lc:
      region: "{{ ec2_region }}"
      name: "{{ item.name }}"
      instance_type: "{{ item.type }}"
      state: absent
    with_items:
      - { name: "{{ bastion_lc_name }}", type: "{{ bastion_instance_type }}" }
    ignore_errors: yes

  # delete Docker registry machines

  - name: get docker-registry instances
    ec2_remote_facts:
      region: "{{ ec2_region }}"
      filters:
        vpc-id: "{{ vpc.vpc_id }}"
        instance-state-name: running
        tag:Name: docker-registry
    register: docker_registry_data
    ignore_errors: yes

  - name: terminate docker-registry instances
    ec2:
      region: "{{ ec2_region }}"
      state: absent
      instance_ids: "{{ item.id }}"
      wait: yes
    with_items: "{{ docker_registry_data.instances }}"

  # delete DNS zone
  - route53:
      command: get
      zone: "{{ vpc_dns_zone }}"
      private_zone: True
      record: "docker-registry.{{ vpc_dns_zone }}"
      type: A
    register: rec
    ignore_errors: yes

  - name: delete DNS records
    route53:
      command: delete
      zone: "{{ vpc_dns_zone }}"
      private_zone: True
      record: "{{ rec.set.record }}"
      ttl: "{{ rec.set.ttl }}"
      type: "{{ rec.set.type }}"
      value: "{{ rec.set.value }}"
    when: "{{ 'set' in rec and rec.set | length > 0 }}"

  - name: delete DNS zone
    route53_zone:
      vpc_id: "{{ vpc.vpc_id }}"
      vpc_region: "{{ ec2_region }}"
      zone: "{{ vpc_dns_zone }}"
      state: absent
    ignore_errors: yes

  # delete security groups
  - name: delete all security groups
    ec2_group:
      region: "{{ ec2_region }}"
      name: "{{ item.name }}"
      description: "{{ item.description }}"
      vpc_id: "{{ vpc.vpc_id }}"
      state: absent
    with_items:
      - { name: "{{ bastion_security_group.name }}" , description: "{{ bastion_security_group.desc }}"}
      - { name: "{{ docker_registry_security_group.name }}" , description: "{{ docker_registry_security_group.desc }}"}
    ignore_errors: yes

  # delete VPC
  - name: delete VPC
    ec2_vpc:
      region: "{{ ec2_region }}"
      cidr_block: "{{ vpc_cidr_block }}"
      resource_tags: "{{ vpc_resource_tags }}"
      vpc_id: "{{ vpc.vpc_id }}"
      state: absent
      wait: yes
